# #{式展開}

授業のテキストの中では、`print`メソッドの引数の中に直接式を埋め込み、それを出力させることでいろいろな動作を確認させています。それぐらい上述の`irb`でやれよという感じがしますが、このようなテスト的な使い方ではなく、実際にプログラムを組む時に、文字列の中に変数の値を埋め込みたい、ということが頻発します。しかし、その度に式と式や文字列の間をコロンで区切るのは、単純に見辛いし、またその見辛さからコロンで区切る場所を間違え、エラーを起こしてしまうことがよくあります。しかしこれは以下の一種の糖衣構文(シンタックスシュガーともいう、書き方の簡単のために特別に導入されている記法一般のことを言います)を使うことでかなり楽になります。

	print(1 + 2, "\n")
	print("#{1 + 2}\n")

この二つは等価です。すなわち、文字列を表すダブルクォーテーションの中に`#{}`という記号を入れ、この中括弧の中に何らかの式を入れることで、その中の式を評価・展開して文字列の中に埋め込んでくれます。この`#{}`という記号は、一つの文字列の中で何回でも使えます。irb で試してみます(何かの動作を確かめたくなったらまず irb！)。

	irb(main):001:0> str = "aiueo"
	=> "aiueo"
	irb(main):002:0> "single: #{str}, double: #{str * 2}"
	=> "single: aiueo, double: aiueoaiueo"

文字列と文字列がコロンで分割されることがなくなるし、エディタによっては`#{}`の部分を文字列とは別の色でハイライトしてくれるので、こちらの方が見易くなります。また、ダブルクォーテーションが 2 つで済むという利点もあります。Ruby で文字列の中に式を埋め込みたい時は恐らくこのやり方が主流だと思います。是非使ってみてください。

この式展開については本文書のコントリビュータである @7kry くんも書いてくれました。彼の記述については[このコミット](https://github.com/7kry/rubylearn/blob/aac9ca324fa7bc3706877866b5e83356f9cdabd0/1-01.md#式展開とフォーマット)をご覧ください。

# "%s(%d)" % ["sprintf", 3]

では、こんな式展開はどうですか。

	names = ["pen", "penguin", "pencil"]
	name = names.sample
	puts "This is a #{ name }, and I love #{ name }."

うーん…。いちいち`name = name.sample`とかやるの、なんか嫌ですね。その下の1行で使うためだけに、name という変数名を使ってしまい、スコープが汚れます。
こうしたらどうですか。
式展開は Ruby でよく使われますが、 Pythonist なんかが大好きなのは、フォーマットです。

	names = ["pen", "penguin", "pencil"]
	puts "This is a %{name}, and I love %{name}." % {name: names.sample}

`{key: expr}`という書き方は、`{:key => expr}`というハッシュの書き方の別の書き方です。これは、`Hash`のインスタンスを作って、`:name`というキーの値として`names.sample`を格納しているので、決してスコープを汚すことはありません。
この書き方は何かというと、`String#%`というインスタンスメソッドを使っています。`"a string".%(〜〜)`と書いても呼べるのですが、`%`という名前のインスタンスメソッドは特別に演算子を定義することになっています(他にも演算子を定義するメソッド名は色々あります)。
`%`という演算子は、`5 % 3 #=> 2`という、「割り算のあまり」を計算する演算子(mod)でしたね。「`String`を`Hash`で割ったあまり」という表現は、「フォーマットされたもの」になります。

フォーマットについて話しだすと、C言語のお話を絶対に避けて通ることができないのが辛いところですね。

	#include <stdio.h>
	int main(void){
		int m, n;        // 変数の宣言(場所とりのようなもの)
		scanf("%d", &m); // 標準入力から数値を読み取りmに格納
		scanf("%d", &n); // 標準入力から数値を読み取りnに格納
		printf("%d + %d = %d\n", m, n, m + n);
	}

1行ずつ2つの数字を入れると(例えば3と4)、足し算の式を表示して(3 + 4 = 7)改行します。表示には`printf(3)`というものを使っています。Ruby にも実は同等の`Kernel.#printf`があります。
この`printf(3)`とは、まず第1引数に「フォーマット」を指定し、何らかの文字列が入るべき場所は`%s`やら`%d`やらが書かれているので、`%d`のところに差し掛かったら、引数を1つ使って数値を表示する、という動作を行います。
それを、標準出力に出すのではなく、文字列を作る`sprintf(3)`があり、やはりRubyにも`Kernel.#sprintf`があります。
そして、`sprintf("%d + %d = %d", m, n, m + n)`とする代わりに、`"%d + %d = %d" % [m, n, m + n]`と書けるのです。
でもでも、フォーマット`%d`は何番目かひと目でわからないのに、配列の要素は何番目に入るものかを意識しないと書けません。こういうのは「セマンティクス的に良くない」のです。
そこで、ハッシュを使って名前をつけよう、という先ほどの提案が出るわけです。

とはいえ、まずは配列で書くsprintfの書き方を覚えないと使い方が分からないので、いくつか覚えておくべきフォーマットを紹介しましょう(もちろん、るりまを見れば載ってますよ)。

`%d`   10進整数(decimal)

`%2d`  2桁で右揃いした10進整数

`%02d` 2桁で右揃いにして、足らない桁を0で埋めた10進整数

……この`2`というのは、`3`にでも`4`にでもできます。`String#rjust`と同じですね(るりまで調べよう！)。

`%x`   16進整数(hexadecimal)

`%X`   16進整数(A-Fが大文字か小文字かで`%x`と異なる)

……勘の良い方はお気づきでしょうが、`%8x`とか`%02X`とか、同様に作れますよ。

`%f`   浮動小数点数

`%.2f` 小数点以下2桁までの浮動小数点数*(非常によく使うので重要)*

……当然`%.2f`の`2`も変えられます。

`%s`   文字列

そしてこれを覚えた上で、ハッシュのフォーマットを使うときには、こうします。

	"%{name} = %<value>.2f" % {name: "Pi", value: Math::PI}

`%{key}`というのは、そのまま`to_s`されて埋め込まれるような感じで、式展開と同じです。`%<key>.2f`というのが、ハッシュのキーで参照する値を指定しつつフォーマットする形です。

というわけで、式展開とフォーマットを駆使して、楽しくコーディングしましょう。

# &lt;&lt;'EOT' # ヒアドキュメント

	print("Content-Type: text/html; charset=UTF-8\n\n")
	print("<!DOCTYPE html>")
	print("<html lang='ja'>")
	# 以下HTMLを1行ずつprint略

どひゃ〜〜〜、って感じですよね。そんな時に助けてくれる、正義の味方ヒアドキュメント。

	require 'cgi'
	
	print <<EOF
	Content-Type: text/html; charset=UTF-8
	
	<!DOCTYPE html>
	<html lang='ja'>
	<!-- 中略 -->
	  <body>
	    <p>#{ CGI::escapeHTML("式展開もできるよ! (>_<)") }</p>
	  </body>
	</html>
	EOF

このように、`<<EOF`で始めたら`EOF`だけで終わる行(インデントがあったり余分な文字が含まれていたりしてはいけない)まで全体が1つのStringのリテラルになります。`EOS`でも`HTML`でもなんでも良いですが、始まりと終わりは同じにしないといけません。
`<`や`>`は、そのままHTMLソースに書き込んでしまうと、タグの開始文字・終了文字として解釈されて「インジェクション」になってしまうので、それをエスケープしたいと思った時、`CGI::escapeHTML`がちからになってあげられるよ! そして、式展開も使えます。
式展開ができたりバックスラッシュエスケープが使えたりするのは、`"ダブルクオーツのStringリテラル"`と同じです。式展開やバックスラッシュエスケープを抑制したければ`<<'EOF'`とします。この場合でも、終端は`EOF`です。

CGIを書く機会が必修科目(知識情報演習I)であると思うので、その時はこれを思い出してあげてください。

EOT
